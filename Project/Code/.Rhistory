View(x)
datasets[[i]] <- x
View(datasets)
rm(list=ls())
folder <- "../Data/Solman2020/"  # path to folder that holds multiple .csv files
file_list <- list.files(path=folder, pattern="*.csv") # create list of all .csv files in folder
#load the csv files into a list
datasets <- lapply(file_list,
function(x)
read.csv(paste(folder, x, sep = ''),
stringsAsFactors = FALSE))
#Remove the first two datasets in our list, we don't need them
datasets[c(1,2)] <- NULL
for (i in 1:3) {
x <- as.data.frame(datasets[i])
newcolumn <- c("EstSpRich")
x[,newcolumn] <- NA
for (j in 1:nrow(x)) {
a <- x$Mean_Cells_per_µL[j]
a <- as.integer(a)
sp <- rpoilog(a, 1, 1, nu=1, condS=FALSE, keep0=FALSE)
x$EstSpRich[j] <- length(unique(sp))
}
datasets[[i]] <- x
}
View(datasets)
points_list <- list() #for storing our fitted points for plotting
results_list <- list() #for storing our RSq and parameter results
plots <- list() #for storing our plots
#define the function
chisholm_model <- function(area, theta, m0, K) {
rho = 1
K = K
Js = area*rho
J_stars = Js/K
ms = m0/sqrt(area)
gamma_stars = J_stars*ms/(1-ms)
return(theta*(digamma(theta/K+gamma_stars*(digamma(gamma_stars+J_stars)-digamma(gamma_stars)))-digamma(theta/K)))
}
View(datasets)
for (j in 1:length(datasets)) {
x <- data.frame(datasets[j])
area <- x[5] #assign the area column of our dataframe to a vector
species_rich <- x[8] #assign the species richness column of our dataframe to a vector
data <- data.frame(area, species_rich) #bind into a new dataframe we will use for fitting
names(data) <- c("area", "species_rich") #rename the columns
data$area <- as.numeric(as.character(data$area)) #make sure all values are numeric or NA
data <- data[complete.cases(data),] #remove NAs
best_fit_results <- NA
best_plot_points <- NA
a <- 0 #for re-setting RSq value after each dataset fit
#Loop through the model fitting, with niche values (K) from 1 to maximum species richness
#calculate R^2 value and store best parameter results
for(K in 1:1000) {
chisholm_fit <- try(nlsLM(species_rich ~ chisholm_model(area, theta, m0, K), data = data, start = list(theta = 200, m0 = 0.0005, K=K)), silent=T)
#Calculate the sum of squared errors - if there was no error in the model fitting!
if(class(chisholm_fit) != "try-error"){
RSS <- sum(residuals(chisholm_fit)^2) #Residual sum of squares of our NLLS model
TSS <- sum((data$species_rich - mean(data$species_rich))^2) #Total sum of squares
RSq <- 1 - (RSS/TSS) #R-squared value
#store these results
results <- data.frame(x[[2]][[1]], RSq, coef(chisholm_fit)["theta"], coef(chisholm_fit)["m0"], K)
names(results) <- c("Author", "R-Squared", "Theta", "Immigration", "Niches")
species <- chisholm_model(area = area, theta = coef(chisholm_fit)["theta"], m0 = coef(chisholm_fit)["m0"], K)
points_plot <- data.frame(area, species)
names(points_plot) <- c("area", "species")
#if the new RSq value is greater than the previous RSq value, store the results
if (RSq > a) {
best_fit_results <- results
best_plot_points <- points_plot
a <- RSq
}
} else {
results <- data.frame(x[[2]][[1]], NA, NA, NA, NA)
names(results) <- c("Author", "R-Squared", "Theta", "Immigration", "Niches")
best_fit_results <- results
}
}
points_list[[j]] <- best_plot_points #store best points for plotting
results_list[[j]] <- best_fit_results #store best RSq parameter results
if(!is.na(results_list[[j]][[2]])) {
#generate a vector of areas to for plotting our model fit
Area <- seq(min(data$area),max(data$area),len=length(data$area))
#remove incomplete cases from our plot points
best_plot_points <- best_plot_points[complete.cases(best_plot_points),]
#plot the most successful model fit with the data
p <- ggplot(data, aes(x=area, y=species_rich)) +
geom_point() +
xlab("Area") +
ylab("Species Richness") +
theme_bw() +
ggtitle(paste("Species-Area Relationship", x[[2]][[1]], x[[1]][[1]])) +
theme(plot.title = element_text(size = 10, face = "bold")) +
geom_line(data = best_plot_points, aes(x = area, y = species)) +
annotate("text",x=(max(data$area)*0.7),y=(max(data$species_rich)*0.5),hjust=.2,label=paste("R-Squared", format(round(results_list[[j]][[2]], 2), nsmall = 2))) +
annotate("text",x=(max(data$area)*0.7),y=(max(data$species_rich)*0.4),hjust=.2,label=paste("Theta", format(round(results_list[[j]][[3]], 2), nsmall = 2))) +
annotate("text",x=(max(data$area)*0.7),y=(max(data$species_rich)*0.3),hjust=.2,label=paste("Immigration", format(round(results_list[[j]][[4]], 2), nsmall = 2))) +
annotate("text",x=(max(data$area)*0.7),y=(max(data$species_rich)*0.2),hjust=.2,label=paste("Niches", results_list[[j]][[5]]))
plots[[j]] <- p
#Save plots
file_name = paste("../Results/Plots/plot_", x[[2]][[1]], ".pdf", sep="")
pdf(file_name)
print(plots[[j]])
dev.off()
}
}
View(results_list)
merged_results <- do.call(rbind, results_list)
merged_results <- as.data.frame(merged_results)
rownames(merged_results) <- NULL
write.csv(merged_results, ("../Results/Stats_Results/TotalResultsSolman.csv"))
View(datasets)
datasets[[1]][["EstSpRich"]]
datasets[[2]][["EstSpRich"]]
datasets[[3]][["EstSpRich"]]
View(datasets)
plot(Immigration_Rate, Mean_cells_per_µL, data = datasets[[1]])
plot(datasets[[1]]$Immigration_Rate, datasets[[1]]$Mean_cells_per_µL)
plot(datasets[[1]]$Immigration_Rate, datasets[[1]]$EstSpRich)
plot(log(datasets[[1]]$Immigration_Rate), datasets[[1]]$EstSpRich)
plot(log(datasets[[1]]$Immigration_Rate), log(datasets[[1]]$EstSpRich))
plot(log(datasets[[1]]$Immigration_Rate), datasets[[1]]$EstSpRich)
rm(list=ls())
graphics.off()
#install nlls fitting package
#install.packages("minpack.lm") <- if you've never installed minpack before
library("minpack.lm") #for nlls fitting
library("ggplot2")
#install.packages("poilog") <- if you've never installed poilog before (for poisson distribution)
library("poilog")
folder <- "../Data/Solman2020/"  # path to folder that holds multiple .csv files
file_list <- list.files(path=folder, pattern="*.csv") # create list of all .csv files in folder
#load the csv files into a list
datasets <- lapply(file_list,
function(x)
read.csv(paste(folder, x, sep = ''),
stringsAsFactors = FALSE))
#Remove the first two datasets in our list, we don't need them
datasets[c(1,2)] <- NULL
for (i in 1:3) {
x <- as.data.frame(datasets[i])
newcolumn <- c("EstSpRich")
x[,newcolumn] <- NA
for (j in 1:nrow(x)) {
a <- x$Mean_Cells_per_µL[j]
a <- as.integer(a)
sp <- rpoilog(a, 1, 1, nu=1, condS=FALSE, keep0=FALSE)
x$EstSpRich[j] <- length(unique(sp))
}
datasets[[i]] <- x
}
points_list <- list() #for storing our fitted points for plotting
results_list <- list() #for storing our RSq and parameter results
plots <- list()
#define the function
chisholm_model <- function(area, theta, m0, K) {
rho = 1
K = K
Js = area*rho
J_stars = Js/K
ms = m0/sqrt(area)
gamma_stars = J_stars*ms/(1-ms)
return(theta*(digamma(theta/K+gamma_stars*(digamma(gamma_stars+J_stars)-digamma(gamma_stars)))-digamma(theta/K)))
}
#FOR EACH DATASET IN THE LIST OF DATAFRAMES
#FIND THE COLUMN WITH SPECIES IN IT AND RENAME THIS SPECIES_RICH
for (j in 1:length(datasets)) {
x <- data.frame(datasets[j])
area <- log(x[5]) #assign the area column of our dataframe to a vector
species_rich <- log(x[8]) #assign the species richness column of our dataframe to a vector
data <- data.frame(area, species_rich) #bind into a new dataframe we will use for fitting
names(data) <- c("area", "species_rich") #rename the columns
data$area <- as.numeric(as.character(data$area)) #make sure all values are numeric or NA
data <- data[complete.cases(data),] #remove NAs
data <- data[is.finite(rowSums(data)),]
best_fit_results <- NA
best_plot_points <- NA
a <- 0 #for re-setting RSq value after each dataset fit
#Loop through the model fitting, with niche values (K) from 1 to maximum species richness
#calculate R^2 value and store best parameter results
for(K in 1:1000) {
chisholm_fit <- try(nlsLM(species_rich ~ chisholm_model(area, theta, m0, K), data = data, start = list(theta = 200, m0 = 0.0005, K=K)), silent=T)
#Calculate the sum of squared errors - if there was no error in the model fitting!
if(class(chisholm_fit) != "try-error"){
RSS <- sum(residuals(chisholm_fit)^2) #Residual sum of squares of our NLLS model
TSS <- sum((data$species_rich - mean(data$species_rich))^2) #Total sum of squares
RSq <- 1 - (RSS/TSS) #R-squared value
#store these results
results <- data.frame(x[[2]][[1]], RSq, coef(chisholm_fit)["theta"], coef(chisholm_fit)["m0"], K)
names(results) <- c("Author", "R-Squared", "Theta", "Immigration", "Niches")
species <- chisholm_model(area = area, theta = coef(chisholm_fit)["theta"], m0 = coef(chisholm_fit)["m0"], K)
points_plot <- data.frame(area, species)
names(points_plot) <- c("area", "species")
#if the new RSq value is greater than the previous RSq value, store the results
if (RSq > a) {
best_fit_results <- results
best_plot_points <- points_plot
a <- RSq
}
} else {
results <- data.frame(x[[2]][[1]], NA, NA, NA, NA)
names(results) <- c("Author", "R-Squared", "Theta", "Immigration", "Niches")
best_fit_results <- results
}
}
points_list[[j]] <- best_plot_points #store best points for plotting
results_list[[j]] <- best_fit_results #store best RSq parameter results
if(!is.na(results_list[[j]][[2]])) {
#generate a vector of areas to for plotting our model fit
Area <- seq(min(data$area),max(data$area),len=length(data$area))
#remove incomplete cases from our plot points
best_plot_points <- best_plot_points[complete.cases(best_plot_points),]
#plot the most successful model fit with the data
p <- ggplot(data, aes(x=area, y=species_rich)) +
geom_point() +
xlab("LogArea") +
ylab("Log Species Richness") +
theme_bw() +
ggtitle(paste("Species-Area Relationship", x[[2]][[1]], x[[1]][[1]])) +
theme(plot.title = element_text(size = 10, face = "bold")) +
geom_line(data = best_plot_points, aes(x = area, y = species)) +
annotate("text",x=(max(data$area)*0.7),y=(max(data$species_rich)*0.5),hjust=.2,label=paste("R-Squared", format(round(results_list[[j]][[2]], 2), nsmall = 2))) +
annotate("text",x=(max(data$area)*0.7),y=(max(data$species_rich)*0.4),hjust=.2,label=paste("Theta", format(round(results_list[[j]][[3]], 2), nsmall = 2))) +
annotate("text",x=(max(data$area)*0.7),y=(max(data$species_rich)*0.3),hjust=.2,label=paste("Immigration", format(round(results_list[[j]][[4]], 2), nsmall = 2))) +
annotate("text",x=(max(data$area)*0.7),y=(max(data$species_rich)*0.2),hjust=.2,label=paste("Niches", results_list[[j]][[5]]))
plots[[j]] <- p
#Save plots
file_name = paste("../Results/Plots/LogAreaSpeciesplot_", x[[2]][[1]], ".pdf", sep="")
pdf(file_name)
print(plots[[j]])
dev.off()
}
}
View(results_list)
merged_results <- do.call(rbind, results_list)
merged_results <- as.data.frame(merged_results)
rownames(merged_results) <- NULL
write.csv(merged_results, ("../Results/Stats_Results/LogAreaSpeciesTotalResultsSolman.csv"))
View(datasets)
View(data)
rm(list=ls())
graphics.off()
#install nlls fitting package
#install.packages("minpack.lm") <- if you've never installed minpack before
library("minpack.lm") #for nlls fitting
library("ggplot2")
#install.packages("poilog") <- if you've never installed poilog before (for poisson distribution)
library("poilog")
folder <- "../Data/Solman2020/"  # path to folder that holds multiple .csv files
file_list <- list.files(path=folder, pattern="*.csv") # create list of all .csv files in folder
#load the csv files into a list
datasets <- lapply(file_list,
function(x)
read.csv(paste(folder, x, sep = ''),
stringsAsFactors = FALSE))
#Remove the first two datasets in our list, we don't need them
datasets[c(1,2)] <- NULL
for (i in 1:3) {
x <- as.data.frame(datasets[i])
newcolumn <- c("EstSpRich")
x[,newcolumn] <- NA
for (j in 1:nrow(x)) {
a <- x$Mean_Cells_per_µL[j]
a <- as.integer(a)
sp <- rpoilog(a, 1, 1, nu=1, condS=FALSE, keep0=FALSE)
x$EstSpRich[j] <- length(unique(sp))
}
datasets[[i]] <- x
}
points_list <- list() #for storing our fitted points for plotting
results_list <- list() #for storing our RSq and parameter results
plots <- list()
#define the function
chisholm_model <- function(area, theta, m0, K) {
rho = 1
K = K
Js = area*rho
J_stars = Js/K
ms = m0/sqrt(area)
gamma_stars = J_stars*ms/(1-ms)
return(theta*(digamma(theta/K+gamma_stars*(digamma(gamma_stars+J_stars)-digamma(gamma_stars)))-digamma(theta/K)))
}
#FOR EACH DATASET IN THE LIST OF DATAFRAMES
#FIND THE COLUMN WITH SPECIES IN IT AND RENAME THIS SPECIES_RICH
for (j in 1:length(datasets)) {
x <- data.frame(datasets[j])
area <- log(x[5]) #assign the area column of our dataframe to a vector
species_rich <- x[8] #assign the species richness column of our dataframe to a vector
data <- data.frame(area, species_rich) #bind into a new dataframe we will use for fitting
names(data) <- c("area", "species_rich") #rename the columns
data$area <- as.numeric(as.character(data$area)) #make sure all values are numeric or NA
data <- data[complete.cases(data),] #remove NAs
best_fit_results <- NA
best_plot_points <- NA
a <- 0 #for re-setting RSq value after each dataset fit
#Loop through the model fitting, with niche values (K) from 1 to maximum species richness
#calculate R^2 value and store best parameter results
for(K in 1:1000) {
chisholm_fit <- try(nlsLM(species_rich ~ chisholm_model(area, theta, m0, K), data = data, start = list(theta = 200, m0 = 0.0005, K=K)), silent=T)
#Calculate the sum of squared errors - if there was no error in the model fitting!
if(class(chisholm_fit) != "try-error"){
RSS <- sum(residuals(chisholm_fit)^2) #Residual sum of squares of our NLLS model
TSS <- sum((data$species_rich - mean(data$species_rich))^2) #Total sum of squares
RSq <- 1 - (RSS/TSS) #R-squared value
#store these results
results <- data.frame(x[[2]][[1]], RSq, coef(chisholm_fit)["theta"], coef(chisholm_fit)["m0"], K)
names(results) <- c("Author", "R-Squared", "Theta", "Immigration", "Niches")
species <- chisholm_model(area = area, theta = coef(chisholm_fit)["theta"], m0 = coef(chisholm_fit)["m0"], K)
points_plot <- data.frame(area, species)
names(points_plot) <- c("area", "species")
#if the new RSq value is greater than the previous RSq value, store the results
if (RSq > a) {
best_fit_results <- results
best_plot_points <- points_plot
a <- RSq
}
} else {
results <- data.frame(x[[2]][[1]], NA, NA, NA, NA)
names(results) <- c("Author", "R-Squared", "Theta", "Immigration", "Niches")
best_fit_results <- results
}
}
points_list[[j]] <- best_plot_points #store best points for plotting
results_list[[j]] <- best_fit_results #store best RSq parameter results
if(!is.na(results_list[[j]][[2]])) {
#generate a vector of areas to for plotting our model fit
Area <- seq(min(data$area),max(data$area),len=length(data$area))
#remove incomplete cases from our plot points
best_plot_points <- best_plot_points[complete.cases(best_plot_points),]
#plot the most successful model fit with the data
p <- ggplot(data, aes(x=area, y=species_rich)) +
geom_point() +
xlab("LogArea") +
ylab("Species Richness") +
theme_bw() +
ggtitle(paste("Species-Area Relationship", x[[2]][[1]], x[[1]][[1]])) +
theme(plot.title = element_text(size = 10, face = "bold")) +
geom_line(data = best_plot_points, aes(x = area, y = species)) +
annotate("text",x=(max(data$area)*0.7),y=(max(data$species_rich)*0.5),hjust=.2,label=paste("R-Squared", format(round(results_list[[j]][[2]], 2), nsmall = 2))) +
annotate("text",x=(max(data$area)*0.7),y=(max(data$species_rich)*0.4),hjust=.2,label=paste("Theta", format(round(results_list[[j]][[3]], 2), nsmall = 2))) +
annotate("text",x=(max(data$area)*0.7),y=(max(data$species_rich)*0.3),hjust=.2,label=paste("Immigration", format(round(results_list[[j]][[4]], 2), nsmall = 2))) +
annotate("text",x=(max(data$area)*0.7),y=(max(data$species_rich)*0.2),hjust=.2,label=paste("Niches", results_list[[j]][[5]]))
plots[[j]] <- p
#Save plots
file_name = paste("../Results/Plots/LogAreaplot_", x[[2]][[1]], ".pdf", sep="")
pdf(file_name)
print(plots[[j]])
dev.off()
}
}
View(results)
View(results_list)
merged_results <- do.call(rbind, results_list)
merged_results <- as.data.frame(merged_results)
rownames(merged_results) <- NULL
write.csv(merged_results, ("../Results/Stats_Results/LogAreaTotalResultsSolman.csv"))
View(x)
rm(list=ls())
graphics.off()
#define metacommunity
J_meta = 1000
Meta = 1:J_meta
#define island community
J_island = 100
Island = rep(1, J_island)
#speciation rate
nu = 0.01
#number of timesteps to run the simulation for
t_max = 100000
#migration rate - proportional the island area
m = 0.005
#compute island death indices, metacommunity/island birth indices and speciation/migration indicies
death_indices = sample(J_island, t_max, replace = T)
birth_indices_island = sample(J_island, t_max, replace = T)
birth_indices_meta = sample(J_meta, t_max, replace = T)
do_speciation = rbinom(t_max, 1, nu)
do_migration = rbinom(t_max, 1, m)
simulation_one_timestep <- function(i) {
if (do_speciation[i]) {
Island[death_indices[i]] <<- length(unique(Meta)) + 1
} else if (do_migration[i]) {
Island[death_indices[i]] <<- Meta[birth_indices_meta[i]]
} else {
Island[death_indices[i]] <<- Island[birth_indices_island[i]]
}
return(Island)
}
multi_timestep <- function(t_max) {
for (i in 1:t_max) {
simulation_one_timestep(i)
}
return(Island)
}
#returns species richness for each migration rate
#set migration rate to 0 so it can be gradually increased
m = 0
species_richness <- list()
migration_multi_timestep <- function () {
for (j in 1:100){
m <<- m + 0.001
do_migration <<- rbinom(t_max, 1, m)
multi_timestep(t_max)
species_richness[[j]] <<- length(unique(Island))
}
}
migration_multi_timestep()
#plot species richness and migration rate
migration_rate = seq(0.001, 0.1, by = 0.001)
plot(migration_rate, species_richness, xlab = "Migration Rate", ylab = "Species Richness", log='y', type='l')
#number of timesteps to run the simulation for
t_max = 10000000
migration_multi_timestep()
rm(list=ls())
graphics.off()
#define metacommunity
J_meta = 1000
Meta = 1:J_meta
#define island community
J_island = 100
Island = rep(1, J_island)
#speciation rate
nu = 0.01
#number of timesteps to run the simulation for
t_max = 1000000
#migration rate - proportional the island area
m = 0.005
#compute island death indices, metacommunity/island birth indices and speciation/migration indicies
death_indices = sample(J_island, t_max, replace = T)
birth_indices_island = sample(J_island, t_max, replace = T)
birth_indices_meta = sample(J_meta, t_max, replace = T)
do_speciation = rbinom(t_max, 1, nu)
do_migration = rbinom(t_max, 1, m)
simulation_one_timestep <- function(i) {
if (do_speciation[i]) {
Island[death_indices[i]] <<- length(unique(Meta)) + 1
} else if (do_migration[i]) {
Island[death_indices[i]] <<- Meta[birth_indices_meta[i]]
} else {
Island[death_indices[i]] <<- Island[birth_indices_island[i]]
}
return(Island)
}
multi_timestep <- function(t_max) {
for (i in 1:t_max) {
simulation_one_timestep(i)
}
return(Island)
}
#returns species richness for each migration rate
#set migration rate to 0 so it can be gradually increased
m = 0
species_richness <- list()
migration_multi_timestep <- function () {
for (j in 1:100){
m <<- m + 0.001
do_migration <<- rbinom(t_max, 1, m)
multi_timestep(t_max)
species_richness[[j]] <<- length(unique(Island))
}
}
migration_multi_timestep()
#plot species richness and migration rate
migration_rate = seq(0.001, 0.1, by = 0.001)
plot(migration_rate, species_richness, xlab = "Migration Rate", ylab = "Species Richness", log='y', type='l')
#migration rate - proportional the island area
m = 0.005
multi_timestep(t_max)
load("/Users/amysolman/Documents/CMEECourseWork/Week9/Code/AmySolmanHPC/simulation_1.rda")
J = 100
size = J
lineages = seq(J, 1)
lineages = rep(J, 1)
lineages = rep(1, J)
abundances = vector()
N = J
v = 0.2
fund_bio_num = v*((J-1)/(1-v))
size = 100
speciation_rate = 0.2
Challenge_D <- function (size, speciation_rate) {
J = size
v = speciation_rate
lineages = rep(1, J)
abundances = vector()
N = J
fund_bio_num = v*((J-1)/(1-v))
}
#Challenge Question D
rm(list=ls())
graphics.off()
size = 100
speciation_rate = 0.2
Challenge_D <- function (size, speciation_rate) {
J = size
v = speciation_rate
lineages = rep(1, J)
abundances = vector()
N = J
fund_bio_num = v*((J-1)/(1-v))
}
#Challenge_D <- function (size, speciation_rate) {
J = size
v = speciation_rate
lineages = rep(1, J)
abundances = vector()
N = J
fund_bio_num = v*((J-1)/(1-v))
j = sample(lineages, 1, replace=T)
?rbinom
?Normal
j = Normal(lineages, 1, replace=T)
j = rnorm(lineages, mean=0, sd=1)
